---
interface Props {
    currentSort?: string;
    currentParams?: Record<string, string>;
}

const { currentSort = 'newest', currentParams = {} } = Astro.props;

const sortOptions = [
    { value: 'newest', label: 'Newest First' },
    { value: 'price-asc', label: 'Price: Low to High' },
    { value: 'price-desc', label: 'Price: High to Low' },
    { value: 'name-asc', label: 'Name: A to Z' },
    { value: 'name-desc', label: 'Name: Z to A' },
];

// Build URL with updated sort parameter
function buildSortUrl(sortValue: string): string {
    const params = new URLSearchParams(currentParams);
    if (sortValue === 'newest') {
        params.delete('sort');
    } else {
        params.set('sort', sortValue);
    }
    params.delete('page'); // Reset to page 1 when sorting
    return `/products${params.toString() ? '?' + params.toString() : ''}`;
}

const currentLabel = sortOptions.find(opt => opt.value === currentSort)?.label || 'Newest First';
---

<div class="flex items-center gap-4">
    <label for="sort-button" class="flex items-center gap-2 font-semibold text-gray-700 text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-primary">
            <path d="M3 6h18M7 12h10m-7 6h4"></path>
        </svg>
        <span class="hidden md:inline">Sort by:</span>
    </label>
    <div class="relative">
        <button type="button" class="flex items-center gap-3 px-5 py-3 bg-white border-2 border-gray-200 rounded-lg font-medium text-gray-700 cursor-pointer transition-all min-w-[200px] justify-between hover:border-primary hover:bg-accent" id="sort-button" aria-haspopup="true" aria-expanded="false">
            <span class="sort-current">{currentLabel}</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="chevron transition-transform">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </button>
        <div class="absolute top-full mt-2 right-0 bg-white border-2 border-gray-200 rounded-lg shadow-lg min-w-[200px] opacity-0 invisible -translate-y-2 transition-all z-50" id="sort-menu" role="menu">
            {sortOptions.map(option => (
                <a
                    href={buildSortUrl(option.value)}
                    class={`flex items-center justify-between px-4 py-3 text-gray-700 text-sm transition-colors border-b border-gray-200 last:border-b-0 hover:bg-accent hover:text-primary ${currentSort === option.value ? 'bg-accent text-primary font-semibold' : ''}`}
                    role="menuitem"
                >
                    {option.label}
                    {currentSort === option.value && (
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="text-primary">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    )}
                </a>
            ))}
        </div>
    </div>
</div>

<script>
    // Toggle dropdown menu
    const sortButton = document.getElementById('sort-button');
    const sortMenu = document.getElementById('sort-menu');

    if (sortButton && sortMenu) {
        sortButton.addEventListener('click', () => {
            const isExpanded = sortButton.getAttribute('aria-expanded') === 'true';
            sortButton.setAttribute('aria-expanded', (!isExpanded).toString());

            if (!isExpanded) {
                sortMenu.classList.remove('opacity-0', 'invisible', '-translate-y-2');
                sortMenu.classList.add('opacity-100', 'visible', 'translate-y-0');
                // Rotate chevron
                const chevron = sortButton.querySelector('.chevron');
                if (chevron) chevron.classList.add('rotate-180');
            } else {
                sortMenu.classList.add('opacity-0', 'invisible', '-translate-y-2');
                sortMenu.classList.remove('opacity-100', 'visible', 'translate-y-0');
                // Rotate chevron back
                const chevron = sortButton.querySelector('.chevron');
                if (chevron) chevron.classList.remove('rotate-180');
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!sortButton.contains(e.target as Node) && !sortMenu.contains(e.target as Node)) {
                sortButton.setAttribute('aria-expanded', 'false');
                sortMenu.classList.add('opacity-0', 'invisible', '-translate-y-2');
                sortMenu.classList.remove('opacity-100', 'visible', 'translate-y-0');
                // Rotate chevron back
                const chevron = sortButton.querySelector('.chevron');
                if (chevron) chevron.classList.remove('rotate-180');
            }
        });
    }
</script>
